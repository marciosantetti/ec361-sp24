<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>.b[Dynamic regression models: Further thoughts]</title>
    <meta charset="utf-8" />
    <meta name="author" content="Prof. Santetti" />
    <script src="010-dynamic-reg-3_files/header-attrs/header-attrs.js"></script>
    <link href="010-dynamic-reg-3_files/remark-css/default.css" rel="stylesheet" />
    <link href="010-dynamic-reg-3_files/remark-css/metropolis.css" rel="stylesheet" />
    <link href="010-dynamic-reg-3_files/remark-css/metropolis-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="skid-css.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# .b[Dynamic regression models: Further thoughts]
]
.subtitle[
## .b[.green[EC 361–001]]
]
.author[
### Prof. Santetti
]
.date[
### Spring 2024
]

---












# Materials

&lt;br&gt;

.b[Required readings]:

&lt;br&gt;


  - [`Hyndman &amp; Athanasopoulos, ch. 10`](https://otexts.com/fpp3/dynamic.html)
  
    - sections 10.3; 10.5.
    


---
class: inverse, middle

# Motivation


---

# Motivation

&lt;br&gt;&lt;br&gt;&lt;br&gt;


After studying the .hi-orange[essentials] of *dynamic regression* models, let us wrap up this topic with a few more .hi-red[practical issues].

---
class: inverse, middle

# Harmonic regression with ARIMA errors

---

# Harmonic regression with ARIMA errors


We have already seen that .hi[harmonic regression] (i.e., using *Fourier* terms) performs well for modeling .hi-red[seasonality].

--

  - Especially *long* seasonal periods (*weekly* and *monthly* seasonal data, for example).
  
--

&lt;br&gt;

One .hi-red[limitation], however, is that harmonic regression assumes that the seasonal component is .hi-blue[fixed] over time (i.e., its variance is constant).

--

With this in mind, harmonic regression is a *useful tool* for seasonal time series.

&lt;br&gt;

--

*Fourier terms* can be used .hi-slate[along with] *ARIMA errors* to capture several important dynamics of the time series at hand.

---


# Harmonic regression with ARIMA errors

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-1-1.svg" style="display: block; margin: auto;" /&gt;


---


# Harmonic regression with ARIMA errors

- Let us start a forecasting exercise for the .hi-slate[air passengers] data set with a *straightforward* regression model. 

--

&lt;br&gt;


```r
air_tslm &lt;- air_ts |&gt; 
  model(reg = TSLM(log(passengers) ~ trend() + season()))
```



---
class: clear



.smallest[

```r
air_tslm |&gt; 
  report()
```

```
#&gt; Series: passengers 
#&gt; Model: TSLM 
#&gt; Transformation: log(passengers) 
#&gt; 
#&gt; Residuals:
#&gt;       Min        1Q    Median        3Q       Max 
#&gt; -0.156370 -0.041016  0.003677  0.044069  0.132324 
#&gt; 
#&gt; Coefficients:
#&gt;                  Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept)     4.7267804  0.0188935 250.180  &lt; 2e-16 ***
#&gt; trend()         0.0100688  0.0001193  84.399  &lt; 2e-16 ***
#&gt; season()year2  -0.0220548  0.0242109  -0.911  0.36400    
#&gt; season()year3   0.1081723  0.0242118   4.468 1.69e-05 ***
#&gt; season()year4   0.0769034  0.0242132   3.176  0.00186 ** 
#&gt; season()year5   0.0745308  0.0242153   3.078  0.00254 ** 
#&gt; season()year6   0.1966770  0.0242179   8.121 2.98e-13 ***
#&gt; season()year7   0.3006193  0.0242212  12.411  &lt; 2e-16 ***
#&gt; season()year8   0.2913245  0.0242250  12.026  &lt; 2e-16 ***
#&gt; season()year9   0.1466899  0.0242294   6.054 1.39e-08 ***
#&gt; season()year10  0.0085316  0.0242344   0.352  0.72537    
#&gt; season()year11 -0.1351861  0.0242400  -5.577 1.34e-07 ***
#&gt; season()year12 -0.0213211  0.0242461  -0.879  0.38082    
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; Residual standard error: 0.0593 on 131 degrees of freedom
#&gt; Multiple R-squared: 0.9835,	Adjusted R-squared: 0.982
#&gt; F-statistic: 649.4 on 12 and 131 DF, p-value: &lt; 2.22e-16
```
]


---
class: clear


.smaller[

```r
air_tslm |&gt; 
  augment() |&gt; 
  gg_tsdisplay(.innov, plot_type = "partial")
```

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-4-1.svg" style="display: block; margin: auto;" /&gt;
]

---


# Harmonic regression with ARIMA errors

- Testing for .hi-slate[residual serial correlation]:


```r
air_tslm |&gt; 
  augment() |&gt; 
  features(.innov, ljung_box, lag = 2 * 12)
```

```
#&gt; # A tibble: 1 × 3
#&gt;   .model lb_stat lb_pvalue
#&gt;   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;
#&gt; 1 reg       417.         0
```


&lt;br&gt;

What do we conclude?
---


# Harmonic regression with ARIMA errors

Moving on to a model with .hi-blue[ARIMA errors]:

&lt;br&gt;


```r
air_arima &lt;- air_ts |&gt; 
  model(arima_errors = ARIMA(log(passengers) ~ trend() + season() + PDQ(0, 0, 0))) # setting PDQ() with zeros, as
                                                                                   # the "season()" function is
                                                                                   # taking care of seasonality.
```


---
class: clear

.smallest[

```r
air_arima |&gt;
  report()
```

```
#&gt; Series: passengers 
#&gt; Model: LM w/ ARIMA(2,0,0) errors 
#&gt; Transformation: log(passengers) 
#&gt; 
#&gt; Coefficients:
#&gt;          ar1     ar2  trend()  season()year2  season()year3  season()year4  season()year5  season()year6  season()year7  season()year8  season()year9  season()year10
#&gt;       0.6746  0.1438    1e-02        -0.0211         0.1099         0.0794         0.0777         0.2004         0.3047         0.2958         0.1515          0.0136
#&gt; s.e.  0.0829  0.0836    4e-04         0.0106         0.0128         0.0145         0.0155         0.0161         0.0163         0.0162         0.0156          0.0147
#&gt;       season()year11  season()year12  intercept
#&gt;              -0.1299         -0.0158     4.7282
#&gt; s.e.          0.0131          0.0109     0.0306
#&gt; 
#&gt; sigma^2 estimated as 0.001337:  log likelihood=279.55
#&gt; AIC=-527.11   AICc=-522.82   BIC=-479.59
```

]



---
class: clear


.smaller[

```r
air_arima |&gt; 
  augment() |&gt; 
  gg_tsdisplay(.innov, plot_type = "partial")
```

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-8-1.svg" style="display: block; margin: auto;" /&gt;
]


---


# Harmonic regression with ARIMA errors

- Testing for .hi-slate[residual serial correlation]:


```r
air_arima |&gt; 
  augment() |&gt; 
  features(.innov, ljung_box, lag = 2 * 12)
```

```
#&gt; # A tibble: 1 × 3
#&gt;   .model       lb_stat lb_pvalue
#&gt;   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;
#&gt; 1 arima_errors    36.6    0.0478
```


&lt;br&gt;

What do we conclude?

---


# Harmonic regression with ARIMA errors

In case we forecast the time series at hand based on a model *with residual serial correlation*, .hi-blue[prediction intervals] will be .hi-red[unreliable].

--


```r
air_arima |&gt; 
  forecast(h = 24) |&gt; 
  head(6)
```

```
#&gt; # A fable: 6 x 4 [1M]
#&gt; # Key:     .model [1]
#&gt;   .model           date        passengers .mean
#&gt;   &lt;chr&gt;           &lt;mth&gt;            &lt;dist&gt; &lt;dbl&gt;
#&gt; 1 arima_errors 1961 Jan t(N(6.1, 0.0013))  451.
#&gt; 2 arima_errors 1961 Feb t(N(6.1, 0.0019))  450.
#&gt; 3 arima_errors 1961 Mar t(N(6.3, 0.0024))  523.
#&gt; 4 arima_errors 1961 Apr t(N(6.2, 0.0028))  516.
#&gt; 5 arima_errors 1961 May  t(N(6.3, 0.003))  523.
#&gt; 6 arima_errors 1961 Jun t(N(6.4, 0.0032))  600.
```


---
class: clear

.smaller[

```r
air_arima |&gt; forecast(h = 24) |&gt; autoplot(air_ts, level = 95, linewidth = .8) + labs(x = "")
```

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-11-1.svg" style="display: block; margin: auto;" /&gt;
]


---


# Harmonic regression with ARIMA errors

So far, we have not been successful in coming up with a *reliable* .hi-slate[regression forecast model] for the air passengers data set.

--

An *alternative* for modeling seasonality is using .hi-red[harmonic regression] .hi-slate[with ARIMA errors].

--

&lt;br&gt;



```r
air_harmonic_fit &lt;- model(air_ts,
              K1 = ARIMA(log(passengers) ~ fourier(K = 1) + PDQ(0, 0, 0)),
              K2 = ARIMA(log(passengers) ~ fourier(K = 2) + PDQ(0, 0, 0)),
              K3 = ARIMA(log(passengers) ~ fourier(K = 3) + PDQ(0, 0, 0)),
              K4 = ARIMA(log(passengers) ~ fourier(K = 4) + PDQ(0, 0, 0)),
              K5 = ARIMA(log(passengers) ~ fourier(K = 5) + PDQ(0, 0, 0)),
              K6 = ARIMA(log(passengers) ~ fourier(K = 6) + PDQ(0, 0, 0)))
```

&lt;br&gt;

Recall that *K*, the number of Fourier sine and cosine pairs, can vary from *K = 1* up to *K = m/2*.


---
class: clear

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-13-1.svg" style="display: block; margin: auto;" /&gt;






---
class: clear


.smallest[

```r
air_harmonic_fit |&gt; 
  select(K6) |&gt; 
  augment() |&gt; 
  gg_tsdisplay(.innov, plot_type = "partial")
```

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-14-1.svg" style="display: block; margin: auto;" /&gt;
]


---


# Harmonic regression with ARIMA errors



.pull-left[
.small[

```r
air_harmonic_fit |&gt; 
  select(K6)
```

```
#&gt; # A mable: 1 x 1
#&gt;                            K6
#&gt;                       &lt;model&gt;
#&gt; 1 &lt;LM w/ ARIMA(1,1,1) errors&gt;
```



```r
air_harmonic_fit |&gt; 
  select(K5)
```

```
#&gt; # A mable: 1 x 1
#&gt;                            K5
#&gt;                       &lt;model&gt;
#&gt; 1 &lt;LM w/ ARIMA(1,1,1) errors&gt;
```
]]


.pull-right[
.small[

```r
air_harmonic_fit |&gt; 
  select(K6) |&gt; 
  augment() |&gt; 
  features(.innov, ljung_box, lag = 2 * 12, dof = 2)
```

```
#&gt; # A tibble: 1 × 3
#&gt;   .model lb_stat lb_pvalue
#&gt;   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;
#&gt; 1 K6        35.6    0.0335
```



```r
air_harmonic_fit |&gt; 
  select(K5) |&gt; 
  augment() |&gt; 
  features(.innov, ljung_box, lag = 2 * 12, dof = 2)
```

```
#&gt; # A tibble: 1 × 3
#&gt;   .model lb_stat lb_pvalue
#&gt;   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;
#&gt; 1 K5        33.9    0.0503
```
]]




---


# Harmonic regression with ARIMA errors

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-19-1.svg" style="display: block; margin: auto;" /&gt;


---
class: inverse, middle

# Scenario-based forecasting


---


# Scenario-based forecasting

When using .hi-slate[regression] models for forecasting, the time series we are interested in forecasting is a .hi[function] of one or more .hi-blue[predictor variables].

--

&lt;br&gt;

Excluding variables we .hi-blue[do know] their future values (e.g., *trend* and *seasonal dummy* variables), we must .hi-slate[make assumptions] about other predictors for which we .hi-red[do not have] information.

--

&lt;br&gt;

This allows us to assume different .hi-slate[scenarios] for the *predictor variables* that are of interest.

--

&lt;br&gt;

Let us come back to our .hi-red[Phillips curve] example.



---


# Scenario-based forecasting









```r
phillips_arima &lt;- phillips_ts |&gt; 
  model(arima_reg = ARIMA(delta_infrate ~ unrate))
```


--

&lt;br&gt;

We will assume .b[3] possible .hi-blue[forecasting scenarios]:

&lt;br&gt;

1. The unemployment rate follows its historical *average value* (5.9%);

2. The unemployment rate *increases* to 10%;

3. The unemployment rate follows its *current value* of 3.36%.

---


# Scenario-based forecasting

&lt;br&gt;



```r
future_scenarios &lt;- scenarios(average = new_data(phillips_ts, n = 5) |&gt; 
                                mutate(unrate = mean(phillips_ts$unrate)),
                              pessimistic = new_data(phillips_ts, n = 5) |&gt; 
                                mutate(unrate = 10),
                              optimistic = new_data(phillips_ts, n = 5) |&gt; 
                                mutate(unrate = 3.36))
```


--

&lt;br&gt;



```r
phillips_scen_fc &lt;- phillips_arima |&gt; 
  forecast(h = 5, new_data = future_scenarios)
```


---
class: clear

.smallest[

```r
phillips_ts |&gt; 
  autoplot(delta_infrate) +
  autolayer(phillips_scen_fc |&gt; filter(.scenario == "average"), level = 95, color = "#4682b4", linewidth = .8) +
  labs(title = "Average scenario")
```

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-24-1.svg" style="display: block; margin: auto;" /&gt;
]


---
class: clear

.smallest[

```r
phillips_ts |&gt; 
  autoplot(delta_infrate) +
  autolayer(phillips_scen_fc |&gt; filter(.scenario == "pessimistic"), level = 95, color = "#800020", linewidth = .8) +
  labs(title = "Pessimistic scenario")
```

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-25-1.svg" style="display: block; margin: auto;" /&gt;
]


---
class: clear

.smallest[

```r
phillips_ts |&gt; 
  autoplot(delta_infrate) +
  autolayer(phillips_scen_fc |&gt; filter(.scenario == "optimistic"), level = 95, color = "#228b22", linewidth = .8) +
  labs(title = "Optimistic scenario")
```

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-26-1.svg" style="display: block; margin: auto;" /&gt;
]

---
class: clear

&lt;img src="010-dynamic-reg-3_files/figure-html/unnamed-chunk-27-1.svg" style="display: block; margin: auto;" /&gt;


---
layout: false
class: inverse, middle

# Next time: Applications

---
exclude: true
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"ratio": "16:9",
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
